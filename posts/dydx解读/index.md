# dYdX解读系列1—白皮书核心内容


> 本文作者：[@7Levy](https://github.com/7Levy)
>
> 白皮书翻译：[@7Levy](https://github.com/7Levy)
>
> 参考链接：
>
> - [dYdX whitepaper-Antonio Juliano](https://whitepaper.dydx.exchange/)写
>
>

## dYdX Introduction

区块链的兴起让任何人都可以在开放网络上拥有和转移资产，而无需去信任任何外方。与现有经济体系结构不同的是，区块链在全世界都是自由且同样可用的。这个现象促使了区块链上数字资产的迅猛增长。许多中心化和去中心化的平台旨在促进已存在资产的高效交换，有更多平台正在开发中。这些平台允许投资者持有各种资产的多头头寸。然而，这些平台目前很难甚至是不可能去持有更复杂的头寸。

dYdX允许创建完全新类别的资产，这些资产可以从基于区块链的底层资产中获利。通过衍生品和保证金交易，投资者们可以用投资组合去实现优秀的风险管理，同时这也开辟了新的投机途径。





## 现有成果

支持衍生品或保证金交易的去中心化协议很少，而且他们都没什么特别重要的用途。中心化交易所们也无法提供足够多的去中心化金融资产。因此，我们很难在现有的大部分去中心化资产上卖空或持有更复杂的头寸。

<!--....待翻译-->



## 协议

dYdX包含了一些列协议，指定不同金融产品的操作和执行。我们计划优先开发最广泛流行的类型。我们在下面大概描述了下期权和保证金交易协议的实现。我们计划在未来开发更多的金融产品。

### 保证金交易协议

**简介**

在一个保证金交易中，交易者借入一项资产然后立马将其换成另一项资产。资产必须偿还给贷方，通常也连同利息一起。 保证金交易中包括卖空和买多。

在卖空交易中，某投资者借入一项资产然后以报价货币将其售出。如果资产价格下跌，由于重新买入后去偿还贷方的成本低于初始售价，那么这个投资者就可以从中获利。如果资产价格上涨，由于重新买入后去偿还贷方的成本高于初始售价，那么这个投资者就会亏损。

在买多交易中，某投资者借入报价货币然后用其买入一项资产。如果价格上涨，投资者获利，如果价格下跌，投资者亏损。持仓的收益或亏损等于标的资产的变化乘以杠杆比例，即借入金额加上交易者支付的金额和交易者支付的金额之比。

**使用案例**

卖空被投资者用于从下跌的资产中获利，卖空可用于投机和对冲。当投资者们认为某项资产价格会下降时，他们可以将卖空作为投机手段。卖空相关资产去对冲现有的持仓。

当资产价格上涨时，买多的杠杆用于乘以收益。买多可用于投机，因为其可以使交易人用更少的资金去获得更多的收益。投资者可以使用买多进行更有效的资金分配，因为每项投资实现相同结果所需的资本更少。

用于保证金头寸的借贷，可以给借贷人带来贷款利息。

**概述**

dYdX保证金交易协议使用了一个主以太坊合约来方便ERC20代币的去中心化保证金交易。贷款方对包含贷款信息(如数量、涉及代币和利率)的消息进行签名，以此来为保证金交易提供贷款。这些贷款可以在非区块链平台上传输和上市。

交易者通过向dYdX保证金合约发送一笔包含贷款要约、借入代币的买单和要借入的金额的交易来建仓。一旦接收到这笔交易，该智能合约将保证金从交易者转移到自己的地址上，然后在外部的去中心化交易所(0x等)使用指定的买单将借出的代币售出。合约在头寸有效期内会保留押金和出售借贷代币所获得的的代币。

当交易者发送一笔包含卖单的交易给合约时，仓位会关闭，这笔卖单以低于或等于抵押金额的价格出售欠贷款方的代币。收到这笔交易后，合约会用外部去中心交易所在订单创建者和其之间执行这笔交易。随后，合约把借出代币的欠款发送给贷款方。欠贷款方的金额包括利息。发送给交易方所有剩余的代币，这等于抵押金和利润。需要注意的是，如果价格和仓位是逆势的，利润可能为负。



<!--....待翻译-->





**实现**

1.合约

对于保证金交易，有三个需要用到的合约：Margin(保证金)合约、Proxy(代理合约)合约以及Vault(金库)合约。

代理合约用于转移用户资金。用户在代理合约上设置代币津贴，授权代理合约代表他们转移资金。

保证金合约提供保证金交易的功能。它包含了所有的业务逻辑和公共函数。其同时也包含了合约存储的仓位状态。保证金合约的设计让现有的仓位无法被外部方修改(参考治理部分)。

金库合约将资金锁仓。它对开提供一个简易的接口，保证金合约有权使用这个接口。

2.Offering Message(供应消息)

保证金的第一要素是持有需借出代币的贷方，并且其希望以给定的押金和利率借出。借贷者准备并以如下消息进行加密签名。

|         变量名         |       变量类型        |                    描述                    |
| :-----------------: | :---------------: | :--------------------------------------: |
|      owedToken      |      address      |           所欠代币的地址-从贷方借得需要还的代币            |
|      heldToken      |      address      |             持有代币的地址-仓位托管的代币              |
|        payer        |      address      | 提供贷款资金的地址-如果该地址和签名者不同，假定它是合约的地址并且通过接口获得许可 |
|       signer        |      address      |             对提供的贷款进行加密签名的地址              |
|        owner        |      address      |          贷款后拥有款项的地址。所有付款将汇入该地址           |
|        taker        | address(optional) |            如果设置该变量，只有该地址可以贷款             |
|    feeRecipient     | address(optional) |             接受款项相关的中继器手续费的地址             |
|   lenderFeeToken    | address(optional) |               贷方手续费的所属代币地址               |
|    takerFeeToken    | address(optional) |               借方手续费的所属代币地址               |
|      maxAmount      |      uint256      |           贷款款项的最大金额。以所欠代币为单位计价           |
|      minAmount      |      uint256      |         贷款款项所能接受的最小金额。以所欠代币为单位计价         |
|    minHeldToken     |      uint256      |       抵押和售出后锁仓的代币最小金额(基于maxAmount)       |
|      lenderFee      | uint256(optional) |            贷方手续费(基于maxAmount)            |
|      takerFee       | uint256(optional) |            借方手续费(基于maxAmount)            |
|    interestRate     |      uint32       |        利率(连续复利，以年度百分率表示，最多保留六位小数)        |
|   interestPeriod    | uint32(optional)  |              利率周期，每个周期增加利率               |
| expirationTimestamp |      uint32       |                 款项到期的时间戳                 |
|    callTimeLimit    |      uint32       |       在贷款方追加保证金后需要关闭仓位的最短时间(按秒计算)        |
|     maxDuration     |      uint256      |            贷款的最长期限，相对于开仓时间计算             |

然后会在交易对手之间进行链下广播该消息。如果交易者愿意，这会成为提交贷款的一个捆绑协议。该协议与用于中继这些已签名消息的交换媒介无关。按照预期这些要约将在作为中继器的中心化平台上列出，并将在利率和条款上展开竞争。较大的OTC交易可以通过传统的方式达成一致，然后使用这个协议进行正式的约束。

3.Buyer(买方)

保证金交易的第二要素是买单，买单作为保证金交易的一部分来填写。和贷款要约类似，买单可以通过任何方式传输。买方不参与贷款和保证金交易。此订单可以是任何价格，并且必须由交易者选择。唯一的先决条件是订单必须至少与交易者作为保证金交易的一部分出售的代币一样多。选择符合交易者经济利益的最优价格完成买单。

dYdX允许任何去中心交易所买/卖的标准。通过封装外部的去中心化交易所的智能合约到一个提供保证金接口的合约中来实现。封装的合约叫做ExchangeWrapper。ExchangeWrapper由交易者在保证金交易中指定，无需特殊权限。这意味着任何人都可以编写、部署和使用ExchangeWrapper作为任何去中心化交易所。dYdX实现的第一个ExchangeWrapper是封装的0x交易所合约，允许任何0x的订单在dYdX上建仓。

4.Position Opening(开仓)

交易者给保证金合约发送一笔交易来开仓：

- 已签名的贷款要约
- 用held token购买owed token的买单
- 用来完成买单的ExchangeWrapper合约地址
- 交易者希望借入的owed token数量
- 一个布尔值，指定交易者是希望用held token还是owed token作为保证金
- 交易者指定的保证金数量
- 开仓的地址

当合约接受到交易会进行如下操作：

1. 验证贷款信息的签名及输入
2. Margin合约首先会调用Proxy合约转移保证金，如果保证金是held token那就把它转移到Vault合约，如果是owed token那就把它转移到ExchangeWrapper合约
3. 保证金合约调用代理合约把所要求数量的owed token从贷方那转移到ExchangeWrapper那
4. 保证金合约记录贷款的使用信息，存储在mapping中。用这种方式可以记录剩余的贷款和避免他人利用已签名的贷款信息进行重放攻击
5. Margin合约调用ExchangeWrapper，根据买单把owed token换成held token。买方作为这笔交易的maker，ExchangeWrapper作为taker。交易合约(如果使用0x的ExchangeWrapper，那就是0x交易合约)会验证买单的签名和输入信息然后执行这笔交易。
6. Margin合约调用Proxy合约,把ExchangeWrapper中卖掉后收到的held token转移到Vault合约。在仓位限期内，held token会在Vault合约中被锁定。
7. 仓位的详情存储在合约里，通过唯一的公共标识进行映射。后续交易者或者贷方可以根据这个标识与仓位进行交互。

所有的步骤都是原子性的
















