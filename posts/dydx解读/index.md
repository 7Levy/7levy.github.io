# dYdX解读系列1—白皮书核心内容


> 本文作者：[@7Levy](https://github.com/7Levy)
>
> 白皮书翻译：[@7Levy](https://github.com/7Levy)
>
> 参考链接：
>
> - [dYdX whitepaper-Antonio Juliano](https://whitepaper.dydx.exchange/)
>
>

## dYdX Introduction

区块链的兴起让任何人都可以在开放网络上拥有和转移资产，而无需去信任任何外方。与现有经济体系结构不同的是，区块链在全世界都是自由且同样可用的。这个现象促使了区块链上数字资产的迅猛增长。许多中心化和去中心化的平台旨在促进已存在资产的高效交换，有更多平台正在开发中。这些平台允许投资者持有各种资产的多头头寸。然而，这些平台目前很难甚至是不可能去持有更复杂的头寸。

dYdX允许创建完全新类别的资产，这些资产可以从基于区块链的底层资产中获利。通过衍生品和保证金交易，投资者们可以用投资组合去实现优秀的风险管理，同时这也开辟了新的投机途径。





## 现有成果

支持衍生品或保证金交易的去中心化协议很少，而且他们都没什么特别重要的用途。中心化交易所们也无法提供足够多的去中心化金融资产。因此，我们很难在现有的大部分去中心化资产上卖空或持有更复杂的头寸。

<!--....待翻译-->



## 协议

dYdX包含了一些列协议，指定不同金融产品的操作和执行。我们计划优先开发最广泛流行的类型。我们在下面大概描述了下期权和保证金交易协议的实现。我们计划在未来开发更多的金融产品。

### 保证金交易协议

**简介**

在一个保证金交易中，交易者借入一项资产然后立马将其换成另一项资产。资产必须偿还给贷方，通常也连同利息一起。 保证金交易中包括卖空和买多。

在卖空交易中，某投资者借入一项资产然后以报价货币将其售出。如果资产价格下跌，由于重新买入后去偿还贷方的成本低于初始售价，那么这个投资者就可以从中获利。如果资产价格上涨，由于重新买入后去偿还贷方的成本高于初始售价，那么这个投资者就会亏损。

在买多交易中，某投资者借入报价货币然后用其买入一项资产。如果价格上涨，投资者获利，如果价格下跌，投资者亏损。持仓的收益或亏损等于标的资产的变化乘以杠杆比例，即借入金额加上交易者支付的金额和交易者支付的金额之比。

**实例**

卖空被投资者用于从下跌的资产中获利，卖空可用于投机和对冲。当投资者们认为某项资产价格会下降时，他们可以将卖空作为投机手段。卖空相关资产去对冲现有的持仓。

当资产价格上涨时，买多的杠杆用于乘以收益。买多可用于投机，因为其可以使交易人用更少的资金去获得更多的收益。投资者可以使用买多进行更有效的资金分配，因为每项投资实现相同结果所需的资本更少。

用于保证金头寸的借贷，可以给借贷人带来贷款利息。

**概述**

dYdX保证金交易协议使用了一个主以太坊合约来方便ERC20代币的去中心化保证金交易。贷款方对包含贷款信息(如数量、涉及代币和利率)的消息进行签名，以此来为保证金交易提供贷款。这些贷款可以在非区块链平台上传输和上市。

交易者通过向dYdX保证金合约发送一笔包含贷款要约、借入代币的买单和要借入的金额的交易来建仓。一旦接收到这笔交易，该智能合约将保证金从交易者转移到自己的地址上，然后在外部的去中心化交易所(0x等)使用指定的买单将借出的代币售出。合约在头寸有效期内会保留押金和出售借贷代币所获得的的代币。

当交易者发送一笔包含卖单的交易给合约时，仓位会关闭，这笔卖单以低于或等于抵押金额的价格出售欠贷款方的代币。收到这笔交易后，合约会用外部去中心交易所在订单创建者和其之间执行这笔交易。随后，合约把借出代币的欠款发送给贷款方。欠贷款方的金额包括利息。发送给交易方所有剩余的代币，这等于抵押金和利润。需要注意的是，如果价格和仓位是逆势的，利润可能为负。



<!--....待翻译-->





**实现**

1.合约

对于保证金交易，有三个需要用到的合约：Margin(保证金)合约、Proxy(代理合约)合约以及Vault(金库)合约。

代理合约用于转移用户资金。用户在代理合约上设置代币津贴，授权代理合约代表他们转移资金。

保证金合约提供保证金交易的功能。它包含了所有的业务逻辑和公共函数。其同时也包含了合约存储的仓位状态。保证金合约的设计让现有的仓位无法被外部方修改(参考治理部分)。

金库合约将资金锁仓。它对开提供一个简易的接口，保证金合约有权使用这个接口。

2.Offering Message

保证金的第一要素是持有需借出代币的贷方，并且其希望以给定的押金和利率借出。借贷者准备并以如下消息进行加密签名。

|         变量名         |       变量类型        |                    描述                    |
| :-----------------: | :---------------: | :--------------------------------------: |
|      owedToken      |      address      |           所欠代币的地址-从贷方借得需要还的代币            |
|      heldToken      |      address      |             持有代币的地址-仓位托管的代币              |
|        payer        |      address      | 提供贷款资金的地址-如果该地址和签名者不同，假定它是合约的地址并且通过接口获得许可 |
|       signer        |      address      |             对提供的贷款进行加密签名的地址              |
|        owner        |      address      |          贷款后拥有款项的地址。所有付款将汇入该地址           |
|        taker        | address(optional) |            如果设置该变量，只有该地址可以贷款             |
|    feeRecipient     | address(optional) |             接受款项相关的中继器手续费的地址             |
|   lenderFeeToken    | address(optional) |               贷方手续费的所属代币地址               |
|    takerFeeToken    | address(optional) |               借方手续费的所属代币地址               |
|      maxAmount      |      uint256      |           贷款款项的最大金额。以所欠代币为单位计价           |
|      minAmount      |      uint256      |         贷款款项所能接受的最小金额。以所欠代币为单位计价         |
|    minHeldToken     |      uint256      |       抵押和售出后锁仓的代币最小金额(基于maxAmount)       |
|      lenderFee      | uint256(optional) |            贷方手续费(基于maxAmount)            |
|      takerFee       | uint256(optional) |            借方手续费(基于maxAmount)            |
|    interestRate     |      uint32       |        利率(连续复利，以年度百分率表示，最多保留六位小数)        |
|   interestPeriod    | uint32(optional)  |              利率周期，每个周期增加利率               |
| expirationTimestamp |      uint32       |                 款项到期的时间戳                 |
|    callTimeLimit    |      uint32       |       在贷款方追加保证金后需要关闭仓位的最短时间(按秒计算)        |
|     maxDuration     |      uint256      |            贷款的最长期限，相对于开仓时间计算             |

然后会在交易对手之间进行链下广播该消息。如果交易者愿意，这会成为提交贷款的一个捆绑协议。该协议与用于中继这些已签名消息的交换媒介无关。按照预期这些要约将在作为中继器的中心化平台上列出，并将在利率和条款上展开竞争。较大的OTC交易可以通过传统的方式达成一致，然后使用这个协议进行正式的约束。

3.Buyer

保证金交易的第二要素是买单，买单作为保证金交易的一部分来填写。和贷款要约类似，买单可以通过任何方式传输。买方不参与贷款和保证金交易。此订单可以是任何价格，并且必须由交易者选择。唯一的先决条件是订单必须至少与交易者作为保证金交易的一部分出售的代币一样多。选择符合交易者经济利益的最优价格完成买单。

dYdX允许任何去中心交易所买/卖的标准。通过封装外部的去中心化交易所的智能合约到一个提供保证金接口的合约中来实现。封装的合约叫做ExchangeWrapper。ExchangeWrapper由交易者在保证金交易中指定，无需特殊权限。这意味着任何人都可以编写、部署和使用ExchangeWrapper作为任何去中心化交易所。dYdX实现的第一个ExchangeWrapper是封装的0x交易所合约，允许任何0x的订单在dYdX上建仓。

4.Position Opening

交易者给保证金合约发送一笔交易来开仓：

- 已签名的贷款要约
- 用held token购买owed token的买单
- 用来完成买单的ExchangeWrapper合约地址
- 交易者希望借入的owed token数量
- 一个布尔值，指定交易者是希望用held token还是owed token作为保证金
- 交易者指定的保证金数量
- 开仓的地址

当合约接受到交易会进行如下操作：

1. 验证贷款信息的签名及输入
2. Margin合约首先会调用Proxy合约转移保证金，如果保证金是held token那就把它转移到Vault合约，如果是owed token那就把它转移到ExchangeWrapper合约
3. 保证金合约调用代理合约把所要求数量的owed token从贷方那转移到ExchangeWrapper那
4. 保证金合约记录贷款的使用信息，存储在mapping中。用这种方式可以记录剩余的贷款和避免他人利用已签名的贷款信息进行重放攻击
5. Margin合约调用ExchangeWrapper，根据买单把owed token换成held token。买方作为这笔交易的maker，ExchangeWrapper作为taker。交易合约(如果使用0x的ExchangeWrapper，那就是0x交易合约)会验证买单的签名和输入信息然后执行这笔交易。
6. Margin合约调用Proxy合约,把ExchangeWrapper中卖掉后收到的held token转移到Vault合约。在仓位限期内，held token会在Vault合约中被锁定。
7. 仓位的详情存储在合约里，通过唯一的公共标识进行映射。后续交易者或者贷方可以根据这个标识与仓位进行交互。

所有的步骤都是原子性的，也就是说这些步骤只能是全部成功或者全部失败。最后，Vault合约中会持有一定数量的held token。如果保证金是held token，数额等于保证金数额加卖出owed token获得的held token的数额。如果保证金是owed token，数额等于卖出借来的owed token与保证金(此时是owed token)得到的held token数额。Vault合约在仓位关闭前会一直锁定资金。

5.Closing

交易者可以在任何时间对部分仓位进行平仓。向Margin合约发送一个卖单，卖单指定卖出held token的数额，只要数额大于或等于欠贷方的owed token数量。卖单可以使任何价格，只要仓位有足够的held token(根据平仓部分占的比例来分配)清算，交易者可以选择最低的价格使得利益最大化。

当Margin合约收到这笔交易，会执行如下操作：

1. 计算欠贷方的owed token总额，使用连续复利的方式计算利息
2. 如果用held token归还，Margin合约调用ExchangeWrapper根据所欠的owed token数额来归还held token；如果用owed token归还，则卖出所有的held token，买入owed token。交易过后，Vault合约会持有所欠数额的owed token和一定数量的held token或是owed token，总额等于保证金和利润(可能为负)。
3. Margin合约调用Proxy合约将所欠数额的owed token从ExchangeWrapper转移到贷方。
4. Margin发送等于保证金+利润数额的held token或owed token给交易者。
5. 如果当前仓位价值为0，Margin会从存储中删除该仓位；如果价值不为0，则根据关闭的仓位大小来减少数额。

在保证金交易结束后，交易者获得利润，利润以held token或是owed token结算。贷方根据owed token计算利息。Margin和Vault合约最终根据需要实现网络中立性。

6.Calling

保证金也可以用另一种方式结算，由贷方或者是贷方授权的第三方从交易者收取贷款。贷方或是贷方授权的第三方向Margin合约发送一笔交易表示正在收取贷款，同时贷方指定交易者必须向存入的held token以此来取消合约调用。发送完这笔交易后，交易者在最初指定的还款时限内(调用时间限制)中去偿还贷款，或者是追加额外的held token。交易者使用上述类似的部分过程平仓。如果交易者平仓失败或者是无法提供所需的额外的保证金，贷方有权收回仓位里的全部held token余额。

当相对于held token的owed token价格上涨至仓位的held token价格位置，此几乎不足以回购owed token，这是最符合贷方利益的时候。这意味着贷方或者是被授权的第三方，需要一直盯盘并在价格上涨时，准备平仓。被授权方很大可能是中继器或服务，观察价格并随时准备按根据价格变动自动收回贷款。授权可信方的方式功能类似使用中心化语言机去决定何时产生保证金追加通知。然而授权可信方的方式效率更高，因为不需要为不断更新的价格支付gas，并且可以实时有效地观察价格，而不是每个区块刷新一次。

这种方式也需要交易者一直在线，并且可以在有限期内发送交易去平仓，否则就会爆仓。为了避免交易者需要一直在线的问题，交易者可以选择外部的合约，该合约可以代表他们自动且无需信任地平仓。自动平仓合约使用荷兰拍卖式的方式，用held token来回购欠贷方的owed token，在限期内held token从0开始，线性增长至仓位里的全部数额的held token。任何多余的held token都会返还给交易者。任何人都可以在拍卖中出价，或者使用一个现有的去中心化交易所购买owed token并保持价差。当拍卖价格超过市场价格，每个人都会有去竞标的动机，这导致了交易者以市场价格成交。

**风险**

对于交易者来说的其中一个风险就是即使存入足够的保证金，贷方也想要收回贷款。当前非区块链相关的金融系统使用信誉系统来识别不会提早回收贷款的最优贷方。dYdX的信誉系统可以完全独立于基础协议，因为交易者更喜欢从评级较高的贷方那借贷，并将其纳入是否贷款的决定中。另外一种解决方法是使用交易者和贷方都相互信任的授权方去追加保证金。将来，还可以使用去中心的价格语言机。

对于贷方的风险(除了持有owed token的经济风险)是owed token相对于held token的价格上涨过快，交易者还没有追加保证金，仓位中的held token就已经不足以回购所欠的owed token代币了。在这种情况下，贷方可以收到交易者仓位的全部held token，但还是持有owed token更好。可以通过设置足够高的抵押金，足够低的催收时间和使用有效地催缴机制(例如通过链下的监控)来降低贷方的风险。



### 期权协议

**简介**

在一个期权中，资产持有人以指定的期权执行价格与未来日期去出售购买或出售该资产的权利。购买资产被称为看涨期权，售出资产被称为看跌期权。期权的卖方(立权人)在出售中收取溢价，但如果期权持有人愿意，那就必须以约定的价格和日期去出售或购买资产。备兑期权指的是将标的资产作为抵押品，因此可以保证未来某个日期收回。期权本身可以在公开市场上交易。我们描述了一种美式备兑期权的实现，或者是一种可以在截止期之前随时执行的期权。

**实例**

期权支持多种交易策略，这些策略可以用于投机和风险管理。

期权可以为投机提供额外的杠杆。举个例子，假设AAPL的价格现在是100美金，有一个投资者投资了1000美金的AAPL并相信其会上涨。投资者可以一100美金的单价购买十股，如果价格涨到110美金，这时候售出，那么就会获得100美金的本金和10%的利润。假设投资者买了执行价为100美金，溢价为2美金的看涨期权。投资者可以买入500个这些期权。如果AAPL价格再次上涨到110美金，投资者可以行使期权以100美金的价格买入AAPL，然后立刻在110美金的价位卖出这些AAPL，每份期权获利10美金。因为投资者必须为每份期权付2美金的溢价，所以对于每份期权来说，最终会是8美金的利润。这意味着投资者的利润会是4000美金，也就是400%的回报。这表明投资者如何利用期权获得比简单持有资产更高的回报。



期权也可以对冲或降低投资风险。假设投资者做多100股AAPL，再次以100美金单价成交。投资者可以以90美金单价购得看跌期权，每份溢价2美金。这种期权会确保仅收取2%的费用，在期权有效期内，投资者的损失不会超过10%。

期权也可以支持更多的交易策略，如跨式、勒式、领式等。这类策略可以锁定价格，从任何方向的波动中获利，或者是从资产的稳定价格中获利。

**概述**

**实现**

1.合约

我们使用三种智能合约来实现期权的发行和功能：Creatot,Proxy和CoverdOption合约。

Creator负责创建所有的CoverdOption合约。任何人都可以创建一种CoverdOption合约，只要提供以下规范：

- ​






























