# dYdX解读—期权协议


> 本文作者：[@7Levy](https://github.com/7Levy)
>
> 白皮书翻译：[@7Levy](https://github.com/7Levy)
>
> 参考链接：
>
> - [dYdX whitepaper-Antonio Juliano](https://whitepaper.dydx.exchange/)
>
>

## 期权交易

### **简介**

在一个期权中，资产持有人以指定的期权执行价格与未来日期去出售购买或出售该资产的权利。购买资产被称为看涨期权，售出资产被称为看跌期权。期权的卖方(立权人)在出售中收取溢价，但如果期权持有人愿意，那就必须以约定的价格和日期去出售或购买资产。备兑期权指的是将标的资产作为抵押品，因此可以保证未来某个日期收回。期权本身可以在公开市场上交易。我们描述了一种美式备兑期权的实现，或者是一种可以在截止期之前随时执行的期权。

### **实例**

期权支持多种交易策略，这些策略可以用于投机和风险管理。

期权可以为投机提供额外的杠杆。举个例子，假设AAPL的价格现在是100美金，有一个投资者投资了1000美金的AAPL并相信其会上涨。投资者可以一100美金的单价购买十股，如果价格涨到110美金，这时候售出，那么就会获得100美金的本金和10%的利润。假设投资者买了执行价为100美金，溢价为2美金的看涨期权。投资者可以买入500个这些期权。如果AAPL价格再次上涨到110美金，投资者可以行使期权以100美金的价格买入AAPL，然后立刻在110美金的价位卖出这些AAPL，每份期权获利10美金。因为投资者必须为每份期权付2美金的溢价，所以对于每份期权来说，最终会是8美金的利润。这意味着投资者的利润会是4000美金，也就是400%的回报。这表明投资者如何利用期权获得比简单持有资产更高的回报。

期权也可以对冲或降低投资风险。假设投资者做多100股AAPL，再次以100美金单价成交。投资者可以以90美金单价购得看跌期权，每份溢价2美金。这种期权会确保仅收取2%的费用，在期权有效期内，投资者的损失不会超过10%。

期权也可以支持更多的交易策略，如跨式、勒式、领式等。这类策略可以锁定价格，从任何方向的波动中获利，或者是从资产的稳定价格中获利。

### **实现**

**1.合约**

我们使用三种智能合约来实现期权的发行和功能：Creator,Proxy和CoverdOption合约。

Creator负责创建所有的CoverdOption。任何人都可以创建一种CoverdOption，只要提供以下规范：

- 期权的ERC20代币地址(称为base token)
- 用来支付执行价格和移除费用的ERC20代币地址(被称为quote token)
- 执行价格（分成两个部分以得到base token和quote token之间的汇率）
- 有效期


创建一种类型的CoveredOption仅开放用于出售，并不会发布任何的期权。对于每个输入参数组合，只能存在唯一的期权。

Proxy合约负载在用户之间转移代币。用户使用ERC20津贴功能去授权Proxy合约转移他们的代币。每一个新的CoverdOption在创建者创建时都会被授权使用Proxy合约转移用户资金。

CoveredOption合约代表一种特定类型的备兑期权。每一个都实现了ERC20代币接口，以允许期权的股份在发行后可以进行交易和转让。这意味着每个期权都可以像任何ERC20代币一样在交易所进行公开交易。

**2.Issuance(期权发行)**

CoveredOption期权使用0x协议的交换功能以促使新期权的发行。期权可以在有效期内的任意时间点发行。为了发行新的期权，卖家需要广播一个已签名的0x格式消息，指定一下信息：

- 立权人(卖家)的地址
- 收款人的地址
- 立权人提供的base token数额
- 购买时，作为溢价支付给立权人的quote token数额
- 期权售卖的有效时间
- 立权人想要立权的CoveredOption合约地址。这个地址在消息的taker字段指定，因此只有CoveredOption合约才可以进行交易

立权人必须至少拥有和消息中所指定的一样多的base token，也必须在Proxy合约里设置津贴。买家买入的期权数量可以少于立权人所提供的的数量。在0x的术语里，立权人是交易的maker(挂单)，CoveredOption是交易的taker(吃单)。该消息可以在任何渠道进行发布，但是必须提供指定的售卖。Relayers(中继器)可以在一个期权发行订单簿上列出售卖的期权(和0x协议的relayers类似)。

当买家们想要购买一个期权，他们需要向CoveredOption合约发送一笔交易，这笔交易包含了消息签名、立权人的广播以及希望买的期权数量。期权与立权人存入的base token数量成1:1正比发行。CoveredOption合约收到交易后，会进行以下操作：

1. 验证期权未超过有效期
2. 调用Proxy合约将适当数量的quote token从买方转移到CoveredOption合约中。这是为期权支付的溢价。
3. 调用0x协议Exchange合约，将买方的quote token和立权人的base token交换。0x的Exchange合约会验证立权人的签名，确保这笔交易是合法的。在这笔交易中，立权人作为maker，ConveredOption合约是taker。然后，立权人最终获得quote token，CoveredOption合约获得base token。清算结束前，CoveredOption合约会一直持有这些base token。
4. CoveredOption合约记录了立权人存取的base token数量。这些base token稍后会在期权到期未执行的情况下用到。
5. 买方的余额会因期权的购买数量而增加。买方现在拥有这部分数量的期权，他们可以按照ERC20的标准自由转让和交易。

所有上述的步骤都是原子性的(一笔交易的步骤全发生，或全部不发生)。

**3.Exercise(期权执行)**

在期权到期之前，任何持有人都可以执行不超过上限数量的期权。这意味着持权人同意为每个期权支付执行价格(GoveredOption创建期间指定)。如果base token的市场价格超过期权执行价格，持权人就会从中受益。

为了执行期权，期权持有人向CoveredOption发送一笔交易，指出有多少期权需要执行。假设这笔交易有效，CoveredOption合约：

1. 调用Proxy合约将strike price×#options的quote token从调用者转移到CoveredOption合约中
2. 从所有者那扣除余额
3. 根据期权执行的数量，1:1发送所有者的base token
4. 所有者持有quote token，部分剩余的会被期权的立权人在稍后收回

**4.Withdrawal(提款)**

在期权到期后，期权的立权人可以取回CoveredOption中的一定比例的base token和quote token：
$$
OptionsWritten/TotalOptionsWritten×(TotalTokensHeld)
$$
向CoveredOption合约发送一个withdraw交易，合约会发送给立权人每种代币的所有月，然后将立权人的余额置0。

如果一个地址时同等数量期权的持权人，也是立权人，则这个地址可以随时取回小于或等于以下数量的base token：
$$
min( OptionsWritten, OptionsHeld)
$$
这么做会同时减少地址的余额和期权数量。这些服务由实体程序提供，所以立权人可以通过购买所需数量的期权拿回base token，即使是期权到期前。

































